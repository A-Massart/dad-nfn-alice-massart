<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Warming API Data</title>
</head>
<body>
    <h1>Données Global Warming API</h1>
    <button id="fetchBtn">Récupérer les données</button>
    <button id="downloadBtn" disabled>Télécharger en Markdown</button>
    <div id="status"></div>
    <pre id="output"></pre>

    <script>
        const endpoints = [
            { name: 'CO₂', url: 'https://global-warming.org/api/co2-api' },
            { name: 'Température', url: 'https://global-warming.org/api/temperature-api' },
            { name: 'Méthane', url: 'https://global-warming.org/api/methane-api' },
            { name: 'Protoxyde d\'azote', url: 'https://global-warming.org/api/nitrous-oxide-api' },
            { name: 'Niveau de la mer', url: 'https://global-warming.org/api/arctic-api' }
        ];

        let collectedData = {};

        async function fetchWithProxy(url) {
            // Essayer d'abord sans proxy
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                }
            } catch (e) {
                console.log('Tentative directe échouée, utilisation du proxy...');
            }

            // Utiliser un proxy CORS
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
            const response = await fetch(proxyUrl);
            
            if (!response.ok) {
                throw new Error(`Erreur HTTP ${response.status}`);
            }
            
            return await response.json();
        }

        async function fetchLatestData() {
            const statusDiv = document.getElementById('status');
            const outputDiv = document.getElementById('output');
            const downloadBtn = document.getElementById('downloadBtn');
            
            statusDiv.textContent = 'Récupération en cours...';
            outputDiv.textContent = '';
            collectedData = {};

            let successCount = 0;
            let failedEndpoints = [];

            for (const endpoint of endpoints) {
                try {
                    statusDiv.textContent = `Récupération de ${endpoint.name}...`;
                    
                    const data = await fetchWithProxy(endpoint.url);
                    
                    // Récupérer la donnée la plus récente
                    let latestData = null;
                    
                    if (data.co2) {
                        latestData = data.co2[data.co2.length - 1];
                    } else if (data.result) {
                        latestData = data.result[data.result.length - 1];
                    } else if (data.methane) {
                        latestData = data.methane[data.methane.length - 1];
                    } else if (data.nitrous) {
                        latestData = data.nitrous[data.nitrous.length - 1];
                    } else if (data.arcticData && data.arcticData.data) {
                        // Structure spéciale pour Arctic API avec objet de données
                        const dates = Object.keys(data.arcticData.data).sort();
                        const latestDate = dates[dates.length - 1];
                        latestData = {
                            date: latestDate,
                            ...data.arcticData.data[latestDate],
                            description: data.arcticData.description
                        };
                    } else if (data.arctic) {
                        latestData = data.arctic[data.arctic.length - 1];
                    }
                    
                    if (latestData) {
                        collectedData[endpoint.name] = latestData;
                        successCount++;
                    } else {
                        collectedData[endpoint.name] = { error: 'Structure de données non reconnue', raw: data };
                    }
                    
                } catch (error) {
                    console.error(`Erreur pour ${endpoint.name}:`, error);
                    collectedData[endpoint.name] = { error: error.message };
                    failedEndpoints.push(endpoint.name);
                }
                
                // Petite pause entre les requêtes
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            displayData();
            
            if (successCount > 0) {
                statusDiv.textContent = `${successCount}/${endpoints.length} endpoints récupérés avec succès !`;
                if (failedEndpoints.length > 0) {
                    statusDiv.textContent += ` Échec: ${failedEndpoints.join(', ')}`;
                }
                downloadBtn.disabled = false;
                
                // Téléchargement automatique si toutes les données sont récupérées
                if (successCount === endpoints.length) {
                    statusDiv.textContent += ' - Téléchargement automatique en cours...';
                    downloadMarkdown();
                }
            } else {
                statusDiv.textContent = 'Erreur: Aucune donnée récupérée. Vérifiez la console pour plus de détails.';
            }
        }

        function displayData() {
            const outputDiv = document.getElementById('output');
            let displayText = '';
            
            for (const [name, data] of Object.entries(collectedData)) {
                displayText += `"${name}" : ${JSON.stringify(data, null, 2)}\n\n`;
            }
            
            outputDiv.textContent = displayText;
        }

        function generateMarkdown() {
            const today = new Date().toISOString().split('T')[0];
            let markdown = `# Données Global Warming - ${today}\n\n`;
            markdown += `*Dernière mise à jour: ${new Date().toLocaleString('fr-FR')}*\n\n`;
            
            for (const [name, data] of Object.entries(collectedData)) {
                markdown += `## ${name}\n\n`;
                
                if (data.error) {
                    markdown += `⚠️ **Erreur**: ${data.error}\n\n`;
                    if (data.raw) {
                        markdown += '```json\n';
                        markdown += JSON.stringify(data.raw, null, 2);
                        markdown += '\n```\n\n';
                    }
                } else {
                    markdown += '```json\n';
                    markdown += JSON.stringify(data, null, 2);
                    markdown += '\n```\n\n';
                }
            }
            
            return markdown;
        }

        function downloadMarkdown() {
            const markdown = generateMarkdown();
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `global-warming-data-${new Date().toISOString().split('T')[0]}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Récupération automatique au chargement
        window.addEventListener('load', fetchLatestData);

        // Récupération automatique tous les jours (24h = 86400000ms)
        setInterval(fetchLatestData, 86400000);

        // Événements boutons
        document.getElementById('fetchBtn').addEventListener('click', fetchLatestData);
        document.getElementById('downloadBtn').addEventListener('click', downloadMarkdown);
    </script>
</body>
</html>